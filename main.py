import requests
import os
import re

if not os.path.isdir('ATM Malware'):
    os.mkdir('ATM Malware')

class Spider():
    def __init__(self, target):
        self.target = target
        self.hashes = dict()
        self.download = 'https://atm.cybercrime-tracker.net/Download/{hash}'

        self.session = requests.Session()
        self.session.headers = {'Authorization': 'Basic aW5mZWN0ZWQ6VFVYdnA3RjM='}

    def find_between(self, *args):
        return re.findall(rf'(?<={args[1]}).+?(?={args[2]})', args[0])

    def retrieve_links(self):
        for link in self.find_between(requests.get(spider.target).text, '#ffff00"><a href="', '<font color="#0000ff'):
            data = link.split('">')[1].split('">')[0].split('</a>')

            hash = data[0].strip()
            name = data[1].replace('/', '.').strip()

            self.hashes[name] = hash

    def crawl(self):
        for name, hash in self.hashes.items():
            path = f'ATM Malware/{name}.rar'

            if not os.path.isfile(path):
                with open(path, 'wb') as file:
                    file.write(self.session.get(self.download.format(hash=hash), allow_redirects=True).content)
                    file.close()

if __name__ == '__main__':
    spider = Spider('https://atm.cybercrime-tracker.net/')
    spider.retrieve_links()
    spider.crawl()
